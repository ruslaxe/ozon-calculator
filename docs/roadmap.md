# Roadmap - Калькулятор юнит-экономики Ozon

## 1. Инициализация проекта

### 1.1 Настройка окружения
- [X] Создать виртуальное окружение Python
- [X] Установить Django и Django REST Framework
- [X] Создать структуру Django проекта
- [X] Настроить settings.py (INSTALLED_APPS, DATABASES, CORS)
- [X] Создать requirements.txt с зависимостями

### 1.2 Структура проекта
- [X] Создать приложение `calculator` для логики калькулятора
- [X] Создать приложение `categories` для работы с категориями
- [X] Настроить URL-маршрутизацию
- [X] Создать базовую структуру директорий (models, serializers, views)

## 2. База данных и модели

### 2.1 Модель категорий товаров
- [X] Создать модель `Category` с полями:
  - name (название категории)
  - fbo_commission (комиссия FBO в %)
  - fbs_commission (комиссия FBS в %)
- [X] Создать и применить миграции для модели Category
- [X] Добавить индексы для поиска по названию

### 2.2 Модель расчетов (опционально для сохранения истории)
- [X] Создать модель `Calculation` для сохранения расчетов пользователя:
  - category (связь с Category)
  - price (цена товара)
  - weight (вес товара)
  - volume (объем товара)
  - length, width, height (габариты)
  - tax_rate (налог на прибыль %)
  - buyout_rate (выкуп %)
  - delivery_time (время доставки в часах)
  - ad_costs_rate (доля рекламных расходов %)
  - cost_price (себестоимость)
  - other_costs (прочие затраты)
  - monthly_sales (количество продаж в месяц)
  - calculation_results (JSON с результатами расчета)
  - created_at (дата создания)
- [X] Создать и применить миграции для модели Calculation

### 2.3 Наполнение данных
- [X] Создать management command для загрузки категорий Ozon
- [X] Подготовить CSV/JSON файл с категориями и комиссиями
- [X] Загрузить начальные данные категорий в БД
- [X] Добавить поле `category_group` для групп категорий
- [X] Создать команду импорта из официальной таблицы Ozon
- [X] Загрузить актуальные данные из официального файла (~15k категорий)

## 3. API эндпоинты - Категории

### 3.1 Поиск категорий
- [X] Создать serializer `CategorySerializer`
- [X] Создать viewset для категорий с фильтрацией по названию
- [X] Настроить поиск по типу товара (name) и категории (category_group)
- [X] Добавить URL для поиска категорий `/api/categories/`
- [X] Реализовать пагинацию результатов поиска

### 3.2 Получение детальной информации о категории
- [X] Создать эндпоинт для получения категории по ID
- [X] Вернуть название, комиссию FBO и FBS в ответе

## 4. API эндпоинты - Калькулятор

### 4.1 Serializer для расчетов
- [X] Создать `CalculationInputSerializer` с полями:
  - category_id (ID выбранной категории)
  - price (цена товара)
  - weight (вес в кг)
  - dimension_mode (режим: "dimensions" или "volume")
  - length, width, height (опционально, для режима габаритов)
  - volume (опционально, для режима объема)
  - tax_rate (налог на прибыль %)
  - buyout_rate (выкуп %)
  - delivery_time (время доставки в часах)
  - ad_costs_rate (доля рекламных расходов %)
  - cost_price (себестоимость за 1 шт)
  - other_costs (прочие затраты на 1 шт)
  - monthly_sales (количество продаж в месяц)
- [X] Добавить валидацию входных данных
- [X] Добавить вычисление объема из габаритов (L × W × H / 1000)

### 4.2 Логика расчета
- [X] Создать сервисный класс `OzonCalculator` с методами:
  - calculate_volume_from_dimensions(length, width, height)
  - calculate_ozon_reward(price, commission_rate)
  - calculate_acquiring(price)
  - calculate_processing_and_delivery(volume, weight)
  - calculate_returns_and_cancellations(price)
  - calculate_ozon_costs_per_unit()
  - calculate_profit_before_costs(price, ozon_costs)
  - calculate_profit_tax(profit_before_costs, tax_rate)
  - calculate_net_profit_per_unit()
  - calculate_profit_for_batch(net_profit, monthly_sales)
- [X] Реализовать расчет для схемы FBO
- [X] Реализовать расчет для схемы FBS
- [X] Добавить расчет процентов и визуальных индикаторов

### 4.3 Эндпоинт расчета
- [X] Создать API view `CalculateAPIView` (POST)
- [X] Принимать данные через `CalculationInputSerializer`
- [X] Вызывать `OzonCalculator` для расчета
- [X] Возвращать результаты в формате:
  - fbo_results (результаты для FBO)
  - fbs_results (результаты для FBS)
  - каждый результат содержит:
    - price (цена товара)
    - ozon_reward (вознаграждение Ozon)
    - acquiring (эквайринг)
    - processing_delivery (обработка и доставка)
    - returns_cancellations (возвраты и отмены)
    - total_ozon_costs (общие затраты на Ozon)
    - profit_before_costs (к начислению за товар)
    - cost_price (себестоимость товара)
    - profit_tax (налог на прибыль)
    - other_costs (прочие затраты)
    - net_profit_per_unit (прибыль за штуку)
    - net_profit_total (прибыль за партию)
    - visual_indicators (данные для визуальных индикаторов)
- [X] Добавить URL `/api/calculate/`

### 4.4 Сохранение расчетов (опционально)
- [ ] Создать эндпоинт для сохранения расчета в БД
- [ ] Создать эндпоинт для получения истории расчетов
- [ ] Добавить возможность удаления сохраненных расчетов

## 5. Дополнительные фичи API

### 5.1 Валидация и обработка ошибок
- [X] Добавить кастомную обработку ошибок (exception handlers)
- [X] Проверять корректность всех входных данных
- [X] Возвращать понятные сообщения об ошибках на русском

### 5.2 Документация API
- [X] Настроить drf-spectacular или drf-yasg
- [X] Добавить описания к эндпоинтам
- [X] Добавить примеры запросов и ответов
- [X] Генерировать OpenAPI схему

## 6. Справочные данные

### 6.1 Тарифы Ozon
- [X] Создать модель или константы для тарифов:
  - Эквайринг (обычно 1-2%)
  - Стоимость обработки и доставки (зависит от объема/веса)
  - Процент возвратов и отмен
- [ ] Сделать эндпоинт для получения актуальных тарифов
- [ ] Возможность обновления тарифов через админку

### 6.2 Django Admin
- [X] Настроить админ-панель для модели Category
- [X] Настроить админ-панель для модели Calculation (если используется)
- [X] Добавить возможность массового импорта категорий
- [X] Настроить фильтры и поиск в админке

## 7. Оптимизация и производительность

### 7.1 Кэширование
- [ ] Настроить кэширование списка категорий
- [ ] Настроить кэширование тарифов Ozon
- [ ] Добавить TTL для кэша

### 7.2 Оптимизация запросов
- [ ] Оптимизировать запросы к БД (select_related, prefetch_related)
- [ ] Добавить индексы для часто используемых полей
- [ ] Проверить N+1 проблемы

## 8. Настройка CORS и безопасность

### 8.1 CORS
- [X] Установить django-cors-headers
- [X] Настроить ALLOWED_ORIGINS для фронтенда
- [X] Настроить разрешенные методы и заголовки

### 8.2 Безопасность
- [X] Настроить ALLOWED_HOSTS
- [ ] Включить HTTPS (в продакшене)
- [ ] Настроить rate limiting для API
- [X] Добавить валидацию входных данных

## 9. Дополнительные улучшения

### 9.1 Экспорт данных
- [X] Добавить возможность экспорта расчета в Excel
- [ ] Добавить возможность экспорта расчета в PDF

### 9.2 Аналитика
- [ ] Добавить счетчики популярных категорий
- [ ] Добавить статистику по расчетам

## 10. Запуск и проверка

### 10.1 Финальная проверка
- [X] Проверить работу всех эндпоинтов
- [X] Проверить корректность расчетов
- [X] Проверить обработку ошибок
- [X] Убедиться в наличии документации API

### 10.2 Подготовка к запуску
- [X] Создать скрипт для инициализации БД
- [X] Создать README.md с инструкциями по запуску
- [X] Подготовить примеры запросов к API
- [X] Запустить сервер разработки и проверить работоспособность

